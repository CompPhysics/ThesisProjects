
\begin{eqnarray}
\frac{1}{\Psi_C}\frac{\partial^2 \Psi_C}{\partial x_k^2} & = & \sum_{i=1}^{k-1}
\frac{1}{g_{ik}}\frac{\partial^2 g_{ik}}{\partial x_k^2} + 
\sum_{i=k+1}^{N}
\frac{1}{g_{ki}}\frac{\partial^2 g_{ki}}{\partial x_k^2}\nonumber\\
& + & \sum_{i=1}^{k-1} \frac{1}{g_{ik}}\frac{\partial g_{ik}}{\partial x_k}
\left(
\sum_{\stackrel{j=1}{j\neq i}}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} +
\sum_{\stackrel{j=k+1}{j\neq i}}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_k}
\right)\nonumber\\
& + &
\sum_{i=k+1}^{N} \frac{1}{g_{ki}}\frac{\partial g_{ki}}{\partial x_k}
\left(\sum_{\stackrel{j=1}{j\neq i}}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} +
\sum_{\stackrel{j=k+1}{j\neq i}}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_k}
\right)\nonumber
\end{eqnarray}
in one dimension, say $x$. The full Laplacian is then the sum of the expression above for all particles $k$ and
all dimensions. 

By using the identity $\frac{\partial^2}{\partial x_i^2}g_{ij} = \frac{\partial^2}{\partial x_j^2}g_{ij}$ on the first line and applying (\ref{firstDerIdentity}) on the second and third lines, as in section (\ref{gradJastrow}), we get the derivatives to operate only over the second index. 
\begin{eqnarray*}
\left[\frac{\nabla^2 \Psi_C}{\Psi_C}\right]_x & = &
2\sum_{k=1}^N\sum_{i=1}^{k-1}
\frac{1}{g_{ik}}\frac{\partial^2 g_{ik}}{\partial x_k^2}\nonumber\\
& + &
\sum_{i=1}^{k-1}
\frac{1}{g_{ik}}\frac{\partial g_{ik}}{\partial x_k}
\left(
\sum_{\stackrel{j=1}{j\neq i}}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} 
 - 
\sum_{\stackrel{j=k+1}{j\neq i}}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_j}
\right)\nonumber\\
& + &
\sum_{i=k+1}^{N}
\frac{1}{g_{ki}}\frac{\partial g_{ki}}{\partial x_i}
\left(
\sum_{\stackrel{j=1}{j\neq i}}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} -
\sum_{\stackrel{j=k+1}{j\neq i}}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_j}
\right)
\end{eqnarray*}
or
\begin{eqnarray*}
\left[\frac{\nabla^2 \Psi_C}{\Psi_C}\right]_x & = &
2\sum_{k=1}^N\sum_{i=1}^{k-1}
\frac{1}{g_{ik}}\frac{\partial^2 g_{ik}}{\partial x_k^2}\nonumber\\
& + &
\sum_{k=1}^N\sum_{i=1}^{k-1}
\frac{1}{g_{ik}}\frac{\partial g_{ik}}{\partial x_k}
\left(
\sum_{\stackrel{j=1}{j\neq i}}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} 
 - 
\sum_{\stackrel{j=k+1}{j\neq i}}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_j}
\right)\nonumber\\
& - &
\sum_{k=1}^N\sum_{i=k+1}^{N}
\frac{1}{g_{ki}}\frac{\partial g_{ki}}{\partial x_i}
\left(
\sum_{\stackrel{j=1}{j\neq i}}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} -
\sum_{\stackrel{j=k+1}{j\neq i}}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_j}
\right)
\end{eqnarray*}
In the second and the third line, for each value of the index $i$, the index $j$ runs over all values
both smaller and greater than $i$. In total we therefore get a
double-counting of the cross multiplied terms. What we ought to do is
to restrict the inner sums to run over $j>i$ and multiply the result 
by $2$. Then, 
\begin{align}
\left[\frac{\nabla^2 \Psi_C}{\Psi_C}\right]_x &=
2\sum_{k=1}^N\sum_{i=1}^{k-1}
\frac{1}{g_{ik}}\frac{\partial^2 g_{ik}}{\partial x_k^2}\nonumber
\\[1mm]
&+
2\sum_{k=1}^N\sum_{i=1}^{k-1}\ \ \;
\frac{1}{g_{ik}}\frac{\partial g_{ik}}{\partial x_k}
\left(
\sum_{j=i+1}^{k-1}
\frac{1}{g_{jk}}\frac{\partial g_{jk}}{\partial x_k} -
\sum_{j=k+1}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_j}
\right)\nonumber\\[1mm]
&+
2\sum_{k=1}^N\sum_{i=k+1}^{N}
\frac{1}{g_{ki}}\frac{\partial g_{ki}}{\partial x_i}
\left(
\sum_{j=i+1}^{N}
\frac{1}{g_{kj}}\frac{\partial g_{kj}}{\partial x_j}
\right).
\end{align}
For the exponential form, things turn out slightly simpler. First of
all it is useful to notice that:
\begin{equation*}
\frac{\nabla^2 \Psi_C}{\Psi_C} =
\left(\nabla^2 \sum g_{ij}\right) +
\left(\bfv{\nabla} \sum g_{ij} \right)^2,
\end{equation*}
where the sums go over all allowed $i$ and $j$. Let us first consider
the Laplacian term:

\begin{equation}
\left(\nabla^2 \sum g_{ij}\right) =
\sum_{k=1}^{N}\nabla^2_k
\sum_{i<j}g_{ij} =
\sum_{k=1}^{N}\nabla^2_k
\left(
\sum_{i=1}^{k-1}g_{ik} +
\sum_{i=k+1}^{N}g_{ki}
\right)
\end{equation}

The $\nabla^2_k$ is just a partial Laplacian over all coordinates of
the $k$th particle. This expression can be split up into separate
terms for each dimension. For clarity we consider just one of those,
denoted by $x,$ and apply eq.~(\ref{eq:partial_g_2}) as before on the second
sum, to switch the derivative from the first to the second index of
$g_{ik}$:

\begin{equation}
\left(\nabla^2 \sum g_{ij}\right)_x =
\sum_{k=1}^{N}
\left(
\sum_{i=1}^{k-1}\frac{\partial^2 g_{ik}}{\partial x_k^2} +
\sum_{i=k+1}^{N}\frac{\partial^2 g_{ki}}{\partial x_i^2}
\right)
\end{equation}

As we noticed earlier on with the Laplacian, it turns out that the
two resulting double sums are actually equal. We therefore arrive at:

\begin{equation}
\left(\nabla^2 \sum g_{ij}\right)_x =
2\sum_{k=1}^N\sum_{i=1}^{k-1}
\frac{\partial^2 g_{ik}}{\partial x_k^2}
\end{equation}

Now consider the square of the gradient. Again the dimensions are
separable and we consider only one:

\begin{equation}
\left(\vec\nabla \sum g_{ij} \right)^2_x =
\sum_{k=1}^N
\left(\frac{\partial}{\partial x_k}\sum_{i<j}g_{ij}\right)^2 =
\sum_{k=1}^N
\left(
\sum_{i=1}^{k-1}\frac{\partial g_{ik}}{\partial x_k} -
\sum_{i=k+1}^{N}\frac{\partial g_{ki}}{\partial x_i}
\right)^2
\end{equation}

In the second of the two inner sums, we have again used
eq.%~(\ref{eq:partial_g_1}) to switch the index of the partial
derivative.


Finally we can sum up the result for the Laplacian ratio of the
exponential form (for one dimension):

\begin{equation}
\left[\frac{\nabla^2 J}{J}\right]_x =\  
2\sum_{k=1}^{N}
\sum_{i=1}^{k-1}\frac{\partial^2 g_{ik}}{\partial x_k^2}\ +\ 
\sum_{k=1}^N
\left(
\sum_{i=1}^{k-1}\frac{\partial g_{ik}}{\partial x_k} -
\sum_{i=k+1}^{N}\frac{\partial g_{ki}}{\partial x_i}
\right)^2
\label{eq:Jratio_Laplacian_exp}
\end{equation}

By now we understand that in order to calculate the desired ratios in
Eq.%~(\ref{eq:derivatives_ratios_J}) we only need to maintain quantities
of the form:

\begin{equation}
\frac{1}{g_{ik}}\frac{\partial g_{ik}}{\partial x_k}\quad
\frac{1}{g_{ik}}\frac{\partial^2 g_{ik}^{\phantom{2}}}{\partial x_k^2}
\qquad\forall\ \ 
i<k
\end{equation}

for all dimensions with the index $k$ running over
all particles (for the specific case of $J$ having the exponential
form, we only need the partial derivatives without the $g$-term in the
denominators). 
{\color{red}{OJO: REEVISAR TODOS ESTOS PARRAFOS PORQU3 NO SE REFIEREN A ESTA TESIS}}
To evaluate the desired ratios the task amounts to
assembling the partial ratios according to the various expressions
given so far. And since the same basic functionality seems to require
slightly different calculation schemes we create separate classes for
the generic and the exponential case. In addition, since the ratio $R$
(see Eq.~(\ref{eq:ratio_new_curr_J})) is evaluated differently whether only
one particle is moved or all, we have correspondingly made two
versions of both the above mentioned classes. This way the user
herself can choose the most efficient evaluation schemes by deciding
which of the available correlation classes to use.

One can treat all the required partial ratios
to be  stored separately for each differentiated dimension in the
familiar form of an upper triangular matrix. As an example, the first
derivatives in the $x$-dimension can be estimated via

$$
 \bfv{g_{x}^{'}} = 
 \begin{pmatrix}
  0 & \frac{1}{g_{1,2}}\frac{\partial g_{1,2}}{\partial x_2} & \frac{1}{g_{1,3}}\frac{\partial g_{1,3}}{\partial x_3} & \cdots & \frac{1}{g_{1,N}}\frac{\partial g_{1,N}}{\partial x_N}\\
  \vdots & 0       & \frac{1}{g_{2,3}}\frac{\partial g_{2,3}}{\partial x_3} & \cdots & \frac{1}{g_{2,N}}\frac{\partial g_{2,N}}{\partial x_N}\\
  \vdots & \vdots  & 0  & \ddots & \vdots  \\
  \vdots & \vdots  & \vdots  & \ddots  & \frac{1}{g_{N-1,N}}\frac{\partial g_{N-1,N}}{\partial x_N}\\
  0 & 0  & 0  & \cdots  & 0 
 \end{pmatrix}
$$ 

and similarly for the second derivatives and all the other dimensions.



{\color{red}{POSIBLEMENTE VOY A ELIMINAR ESTO PORQUE ASI NO LO IMPLEMENTE, AL NO SER QUE ME ARREPIENTA DE USASR LA CLASE PARA DERIVADAS MMMMMMMMMMMMMMMMMM}}
First and second derivatives are estimated by the standard second order
finite difference scheme, resulting in for the upper differences
$\bfv g_{x}^{+}$

$$
 \bfv{g_{x}^{+}} = 
 \begin{pmatrix}
  0 & g_{1,2}(x_2 + \Delta x) & g_{1,3}(x_3 +  \Delta x) & \cdots & g_{1,N}(x_N +  \Delta x) \\
  \vdots & 0       & g_{2,3}(x_3 + \Delta x) & \cdots & g_{2,N}(x_N + \Delta x) \\
  \vdots & \vdots  & 0  & \ddots & \vdots  \\
  \vdots & \vdots  & \vdots  & \ddots  & g_{N-1,N}(x_N + \Delta x) \\
  0 & 0  & 0  & \cdots  & 0 
 \end{pmatrix}
$$

For the lower differences $\bfv g_{x}^{-}$:

$$
 \bfv{g_{x}^{-}} = 
 \begin{pmatrix}
  0 & g_{1,2}(x_2 - \Delta x) & g_{1,3}(x_3 -  \Delta x) & \cdots & g_{1,N}(x_N -  \Delta x) \\
  \vdots & 0       & g_{2,3}(x_3 - \Delta x) & \cdots & g_{2,N}(x_N - \Delta x) \\
  \vdots & \vdots  & 0  & \ddots & \vdots  \\
  \vdots & \vdots  & \vdots  & \ddots  & g_{N-1,N}(x_N - \Delta x) \\
  0 & 0  & 0  & \cdots  & 0 
 \end{pmatrix}
$$






A term from each $\bfv g$, $\bfv g^+$ and $\bfv g^-$ is then enough
to evaluate one partial ratio. A first derivative partial ratio is
via the three-point formula

\begin{equation}
\frac{1}{g_{ik}}\frac{\partial g_{ik}}{\partial x_k} =
\frac{1}{g_{ik}}
\left(\frac{g_{ik}^+ - g_{ik}^-}{2h} \right) + \mathcal{O}(h^2)
\end{equation}

and a second derivative partial ratio:

\begin{equation}
\frac{1}{g_{ik}^{\phantom{2}}}
\frac{\partial^2 g_{ik}}{\partial x_k^2} =
\frac{1}{g_{ik}^{\phantom{2}}}
\left(\frac{g_{ik}^+ - 2g_{ik}^{\phantom{+}} + g_{ik}^-}{2h}\right) +
\mathcal{O}(h^2)
\end{equation}


MMMMMMMMMM
MMMMMMMMM

It can be shown (see appendix (\ref{laplacianJastrowDer}) for details) that in a expression for the laplacian-Jastrow ratio in one dimension (here assumed to be $x$) is given by

\begin{equation}
\boxed{\left[\frac{\nabla^2 \Psi_C}{\Psi_C}\right]_x =\  
2\sum_{k=1}^{N}
\sum_{i=1}^{k-1}\frac{\partial^2 g_{ik}}{\partial x_k^2}\ +\ 
\sum_{k=1}^N
\left(
\sum_{i=1}^{k-1}\frac{\partial g_{ik}}{\partial x_k} -
\sum_{i=k+1}^{N}\frac{\partial g_{ki}}{\partial x_i}
\right)^2}
\end{equation}
